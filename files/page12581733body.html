<!--allrecords--><div id="allrecords" data-tilda-export="yes" class="t-records" data-hook="blocks-collection-content-node" data-tilda-project-id="14542" data-tilda-page-id="12581733" data-tilda-page-alias="blog/otchyoty-o-rassylkah-iz-unisender-v-power-bi-chast-2" data-tilda-formskey="2bb761110255242a2bbb1bf3f837b680" data-tilda-lazy="yes" data-tilda-project-headcode="yes"><!--header--><div id="t-header" class="t-records" data-hook="blocks-collection-content-node" data-tilda-project-id="14542" data-tilda-page-id="61936" data-tilda-page-alias="header" data-tilda-formskey="2bb761110255242a2bbb1bf3f837b680" data-tilda-project-headcode="yes"></div><!--/header--><div id="rec209957034" class="r t-rec" style=" " data-animationappear="off" data-record-type="891" ><!-- cover --><div class="t-cover" id="recorddiv209957034" bgimgfield="img" style="height:450px; background-image:-webkit-linear-gradient(top, #ccc, #777); background-image:-moz-linear-gradient(top, #ccc, #777); background-image:-o-linear-gradient(top, #ccc, #777); background-image:-ms-linear-gradient(top, #ccc, #777); background-image:linear-gradient(top, #ccc, #777); " ><div class="t-cover__carrier" id="coverCarry209957034" data-content-cover-id="209957034" data-content-cover-bg="" data-content-cover-height="450px" data-content-cover-parallax="" style="height:450px;background-attachment:scroll; "></div> <div class="t-cover__filter" style="height:450px;background-image: -moz-linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));background-image: -webkit-linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));background-image: -o-linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));background-image: -ms-linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));background-image: linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));filter: progid:DXImageTransform.Microsoft.gradient(startColorStr='#000e1f2f', endColorstr='#00182d42');"></div><div class="t891"> <div class="t-container"> <div class="t-col t-col_12"> <div class="t-cover__wrapper t-valign_middle" style="height:450px;"> <div class="t891__wrapper" data-hook-content="covercontent"> <div class="t891__title t-title t-title_xl" style="padding-top:100px;text-shadow: 0px 2px 5px rgba(0, 0, 0, 0.0);" field="title"><div style="font-size:46px;text-align:left;" data-customstyle="yes">Отчёты о рассылках из UniSender в Power BI. <br />Часть 2. Обработка отчета в Power BI<br /></div></div> <div class="t891__descr t-descr t-descr_xl " style="" field="descr"><div style="font-size:18px;text-align:left;" data-customstyle="yes">Продолжение <a href="https://learn.needfordata.ru/blog/otchyoty-o-rassylkah-iz-unisender-v-power-bi-chast-1" target="_blank">статьи</a> от <a href="http://emailsoldiers.ru/" target="_blank">EmailSoldiers</a> по созданию автоматических отчетов из сервиса рассылок Unisender в Power BI.</div></div> <span class="space"></span> </div> </div> </div> </div></div> </div> </div><div id="rec209957038" class="r t-rec t-rec_pt_90 t-rec_pb_0" style="padding-top:90px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Научимся принимать и обрабатывать запросы из Unisender в Power BI. Первая часть статьи <a href="https://learn.needfordata.ru/blog/otchyoty-o-rassylkah-iz-unisender-v-power-bi-chast-1" target="_blank">по ссылке</a>. <br /><br /> Запускаем Power BI. На первом этапе мы будем работать с редактором запросов (Query Editor).<br /></div></div></div></div></div></div><div id="rec209957039" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_6 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild6665-6532-4464-a633-353064323861__-__empty__d057c5b2b8.png" data-original="images/tild6665-6532-4464-a633-353064323861__d057c5b2b8.png" imgfield="img" /><meta itemprop="image" content="images/tild6665-6532-4464-a633-353064323861__d057c5b2b8.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec209957040" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Работа над отчётом будет строиться следующим образом.<br />Сначала получим от UniSender по API все необходимые данные, затем обработаем их.<br />На третьем шаге сделаем визуализацию.<br />После всего этого посмотрим, как выложить этот отчёт в онлайн, чтобы за ним могли смотреть заказчик или команда. <br /><br /> Открываем Query Editor и совершаем первый запрос.<br />Кликаем в Новый источник данных (New Source).<br /></div></div></div></div></div></div><div id="rec209957041" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild6335-6161-4030-b735-326331313763__-__empty__ed56fe5010.png" data-original="images/tild6335-6161-4030-b735-326331313763__ed56fe5010.png" imgfield="img" /><meta itemprop="image" content="images/tild6335-6161-4030-b735-326331313763__ed56fe5010.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec209957042" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Выбираем подходящий источник. Данные мы получаем из интернета по ссылке, поэтому как в качестве источника выбираем Web:</div></div></div></div></div></div><div id="rec209957043" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild6336-3762-4130-b134-323066636335__-__empty__7c89b12180.png" data-original="images/tild6336-3762-4130-b134-323066636335__7c89b12180.png" imgfield="img" /><meta itemprop="image" content="images/tild6336-3762-4130-b134-323066636335__7c89b12180.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec209957044" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">В URL вставляем нашу ссылку запроса по методу getCampaigns, которую мы уже проверили в Postman.</div></div></div></div></div></div><div id="rec209957045" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild3366-3464-4665-a365-303864633035__-__empty__ab503a4e64.png" data-original="images/tild3366-3464-4665-a365-303864633035__ab503a4e64.png" imgfield="img" /><meta itemprop="image" content="images/tild3366-3464-4665-a365-303864633035__ab503a4e64.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec209957046" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Получили данные. Результат нам пришёл в виде списка (List). Давайте посмотрим, что же произошло после отправки формы. <br /><br /> Power BI сохранил наш запрос в списке запросов. Он выполнил этот запрос и полученные данные в формате JSON вернул нам в виде List-а. И ещё он записал наше первое действие в секции APPLIED STEPS. Откроем этот запрос в редакторе запросов (Advanced Editor).<br /></div></div></div></div></div></div><div id="rec209958989" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild6662-3462-4738-a362-383766626638__-__empty__5daa311555.png" data-original="images/tild6662-3462-4738-a362-383766626638__5daa311555.png" imgfield="img" /><meta itemprop="image" content="images/tild6662-3462-4738-a362-383766626638__5daa311555.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec209959032" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Разберём код:</div></div></div></div></div></div><div id="rec209959446" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">let  
Source = Json.Document(Web.Contents(&quot;http://api.unisender.com/ru/api/getCampaigns?format=
json&amp;api_key=xxxxxxxxxxxxxxxxxxxxxxxx&quot;))  
in   
Source</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec209959777" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Вот наша ссылка. Указан тип источника Web.Contents — веб содержимое. Выполняя запрос, Power BI прочитал заголовок ответа, увидел, что ответ приходит в виде JSON, поэтому Power BI самостоятельно принял решение читать данные, как JSON, и поэтому здесь появилась функция Json.Document. <br /><br /> Если бы возвращаемые данные были в каком-то другом формате, например, в XML, на этом месте оказалась бы другая соответствующая функция. Тут следует сказать, что язык запросов Power BI — это «MS Power Query», также известный, как «M». Безусловно, нам понадобится <a href="https://msdn.microsoft.com/en-us/library/mt211003.aspx">документация</a> по этому языку. В настоящий момент для нас самое главное усвоить структуру запроса. <br /><br /> Сам запрос и вообще все манипуляции производятся после выражения let, а возвращаемый результат следует после in. Редактор запросов Power BI не имеет подсветки синтаксиса, автоматического переноса строк и поиска. По сути своей, это не редактор вовсе, а поле ввода. Поэтому читать код и работать с кодом в нём неудобно. <br /><br /> Однако Power Query имеет синтаксис, отдалённо похожий на синтаксис JavaScript. Поэтому для работы с кодом запросов на языке M можно использовать любой редактор кода в режиме подсветки синтаксиса JavaScript:<br /></div></div></div></div></div></div><div id="rec209960376" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild6432-6438-4262-a561-363365633631__-__empty__24ab7afc92.png" data-original="images/tild6432-6438-4262-a561-363365633631__24ab7afc92.png" imgfield="img" /><meta itemprop="image" content="images/tild6432-6438-4262-a561-363365633631__24ab7afc92.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec209960447" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Вернёмся к Power BI. <br /><br /> Опишу сразу конечную задачу, к которой мы будем стремиться. Полученные первым запросом данные пока не являются таблицей. Нам надо не только получать данные от источников, но также проделывать ряд операцией, приводящих сырые данные к табличному, пригодному для дальнейшего использования, виду. Мы можем просмотреть содержимое полученного списка, кликнув в его ячейку. Мы видим, что внутри списка содержатся записи (Record). Открываем список кликом по ссылке «List» в ячейке данных. Обращаем внимание на то, что в списке примененных шагов (APPLIED STEPS) появился новый пункт «Navigation» и в редакторе запросов также появилась соответствующая функция.<br /></div></div></div></div></div></div><div id="rec209960766" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild3565-3536-4631-b464-343038333264__-__empty__9edc2867f8.png" data-original="images/tild3565-3536-4631-b464-343038333264__9edc2867f8.png" imgfield="img" /><meta itemprop="image" content="images/tild3565-3536-4631-b464-343038333264__9edc2867f8.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec209960494" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes"> Вообще все манипуляции с данными в визуальном редакторе Query Editor находят своё отражение в списке шагов и в коде запросов. <br /><br /> Теперь просмотрим содержимое записей. Мы видим, что в каждой записи находятся данные об одной рассылке.<br /></div></div></div></div></div></div><div id="rec209961104" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild3466-3763-4233-b362-626533643437__-__empty__124b589a1b.png" data-original="images/tild3466-3763-4233-b362-626533643437__124b589a1b.png" imgfield="img" /><meta itemprop="image" content="images/tild3466-3763-4233-b362-626533643437__124b589a1b.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec209961194" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Если мы кликнем в запись, то получим не тот результат, к которому мы стремимся. Поэтому мы отменим действие Navigation и снова откроем лист. Преобразуем наш список записей к табличному виду с помощью стандартного инструмента Power BI — To Table.</div></div></div></div></div></div><div id="rec209961587" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild3361-3732-4332-a461-666366366338__-__empty__f4f6178f1a.png" data-original="images/tild3361-3732-4332-a461-666366366338__f4f6178f1a.png" imgfield="img" /><meta itemprop="image" content="images/tild3361-3732-4332-a461-666366366338__f4f6178f1a.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec209961651" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">И теперь раскроем записи. В форме раскрытия мы можем выбрать данные, которые останутся в таблице на следующем шаге. <br /><br /> <strong>Небольшое лирическое отступление:</strong><br />Мы видим предупреждение List may be incomplete (список может быть не полным), и это очень важный момент. По умолчанию Power BI анализирует только первые несколько записей и предлагает раскрыть поля, которые присутствуют в них. Но реально бывает так, что в какой-то 155-й по счёту записи появляется поле, которого в предыдущих записях не было. Чтобы это значение попало в список раскрываемых данных, необходимо кликнуть на ссылку Load more. Желательно это делать всегда. И даже так будет просканировано только 1000 первых записей. Если вы уверены в том, что каких-то данных после этого шага недостает, вы всегда можете доработать запрос в редакторе запросов, вручную добавив недостающие поля.<br /></div></div></div></div></div></div><div id="rec209961909" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild3233-3765-4563-a262-303365323836__-__empty__802044285c.png" data-original="images/tild3233-3765-4563-a262-303365323836__802044285c.png" imgfield="img" /><meta itemprop="image" content="images/tild3233-3765-4563-a262-303365323836__802044285c.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec209961959" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Также в данном случае, можно деактивировать чекбокс «Use original column name as prefix». Если от префикса избавиться, то названия столбцов будут более компактными. Так что я деактивировал чекбокс. <br /><br /> Итак, раскрываем записи. Этот шаг зафиксирован. <br /><br /> Смотрим в код:<br /></div></div></div></div></div></div><div id="rec209962274" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">let  
Source = Json.Document(
Web.Contents(
&quot;http://api.unisender.com/ru/api/getCampaigns?format=
json&amp;api_key=5tmjbcir5g4xuew573mxcoh4ypo98xbbbadqgs4a&quot;)),  
result = Source[result],  
#&quot;Converted to Table&quot; = Table.FromList(result, Splitter.SplitByNothing(), null, null, ExtraValues.Error),  
#&quot;Expanded Column1&quot; = Table.ExpandRecordColumn(#&quot;Converted to Table&quot;, &quot;Column1&quot;, 
{&quot;id&quot;, &quot;start_time&quot;, &quot;status&quot;, &quot;message_id&quot;, &quot;list_id&quot;, &quot;subject&quot;, &quot;sender_name&quot;, &quot;sender_email&quot;, &quot;stats_url&quot;},
{&quot;id&quot;, &quot;start_time&quot;, &quot;status&quot;, &quot;message_id&quot;, &quot;list_id&quot;, &quot;subject&quot;, &quot;sender_name&quot;, &quot;sender_email&quot;, &quot;stats_url&quot;})  
in  
#&quot;Expanded Column1&quot;</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec209962571" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">За последние два шага у нас появились две новых функции: Table.FromList и Table.ExpandRecordColumn. Позже мы будем дорабатывать код запросов в редакторе запросов. Но я не буду подробно останавливаться на каждой функции, на принципах их работы. Подробную информацию о любой функции можно найти в документации по Power Query. Например, для этих двух: <a href="https://msdn.microsoft.com/en-us/library/mt260762.aspx">Table.FromList</a> и <a href="https://msdn.microsoft.com/en-us/library/mt260752.aspx">Table.ExpandRecordColumn</a>. <br /><br /> Итак, табличные данные мы получили. Теперь обращаем внимание на то, что у всех данных в таблице сейчас тип данных Any – буквально «любой». Power BI, конечно, попробует сам угадать тип данных в процессе их использования, но он не всегда делает это успешно. Поэтому, чтобы потом успешно работать с данными, надо сейчас определиться с их типом.<br /></div></div></div></div></div></div><div id="rec209962904" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild3030-6164-4336-b765-653539653035__-__empty__4dfb2e12dd.png" data-original="images/tild3030-6164-4336-b765-653539653035__4dfb2e12dd.png" imgfield="img" /><meta itemprop="image" content="images/tild3030-6164-4336-b765-653539653035__4dfb2e12dd.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec209962994" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Первым делом мы выделяем всю таблицу Ctrl+A, и в разделе Transform ленты кликаем по кнопке Detect Data Type.<br /></div></div></div></div></div></div><div id="rec209969354" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild6532-3933-4431-b430-356137343462__-__empty__1c9baf195e.png" data-original="images/tild6532-3933-4431-b430-356137343462__1c9baf195e.png" imgfield="img" /><meta itemprop="image" content="images/tild6532-3933-4431-b430-356137343462__1c9baf195e.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec209969524" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">На этом шаге Power BI фиксирует в коде свои догадки относительно природы данных. Их надо откорректировать вручную. Практика показала, что уникальный идентификатор должен быть всегда в текстовом формате, даже если он состоит из одних только цифр. <br /><br /> Меняем тип у соответствующего столбца:<br /></div></div></div></div></div></div><div id="rec209963185" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild6261-6538-4331-b361-616564643365__-__empty__24d734f050.png" data-original="images/tild6261-6538-4331-b361-616564643365__24d734f050.png" imgfield="img" /><meta itemprop="image" content="images/tild6261-6538-4331-b361-616564643365__24d734f050.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec209963232" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Формат всех остальных данных нас, в принципе, устраивает. Переименуем наш первый запрос. Этим запросом мы получили информацию о кампаниях, вот и назовём наш запрос «Campaigns».</div></div></div></div></div></div><div id="rec209963437" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild3862-6562-4962-a361-616166613038__-__empty__37b8a55e14.png" data-original="images/tild3862-6562-4962-a361-616166613038__37b8a55e14.png" imgfield="img" /><meta itemprop="image" content="images/tild3862-6562-4962-a361-616166613038__37b8a55e14.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec209963501" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Теперь вернёмся в документацию UniSender и посмотрим, какие ещё данные для нашего отчёта мы можем получить с помощью API. Будем дальше развивать тему кампаний. <br /><br /> Нам нужна подробная статистика о результатах каждой осуществлённой рассылки (статистика доставляемости, кликов, ошибок, отписок и т.д.). В API UniSender такую информацию возвращают методы <a href="https://www.unisender.com/ru/support/integration/api/getCampaignCommonStats">getCampaignCommonStats</a> и <a href="https://www.unisender.com/ru/support/integration/api/getcampaignaggregatestats">getCampaignAggregateStats</a>. <br /><br /> Вы можете их подробно рассмотреть в документации платформы. Я, в свою очередь, уже это сделал и определился с тем, что лучше подходит метод getCampaignCommonStats (этот метод в API платформы UniSender появился совсем недавно). В документации метода мы видим, что в качестве аргумента, кроме обязательного для всех запросов API-key, мы должны использовать id кампании. <br /><br /> ID всех кампаний мы уже получали ранее при помощи метода getCampaigns, и они находятся в результатах запроса, который мы назвали Campaigns. Получается, теперь нам надо эти данные использовать в новом запросе. <br /><br /> Для начала проверим работу метода в Postman. <br /><br /> Превосходно! Метод getCampaignCommonStats вернул нам всю основную информацию о рассылке.<br /></div></div></div></div></div></div><div id="rec209963637" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild3466-3166-4261-a362-613465626363__-__empty__8aa2cec503.png" data-original="images/tild3466-3166-4261-a362-613465626363__8aa2cec503.png" imgfield="img" /><meta itemprop="image" content="images/tild3466-3166-4261-a362-613465626363__8aa2cec503.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec209963954" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Теперь используем его в Power BI. Сначала для одной кампании. <br /><br /> Результат мы получили в виде записи. <br /><br /> Назовем этот запрос CampaignCommonStats. <br /><br /> Далее нам надо сделать запрос, который будет содержать внутри себя несколько запросов getCampaignCommonStats (отдельный для каждой компании). С точки зрения кода запроса, нам нужен цикл. Используя графический интерфейс Query Editor, решить эту задачу невозможно, поэтому нам надо самостоятельно написать нужный нам запрос. Но как это сделать? <br /><br /> Гуглим «power query cycle». <a href="https://social.technet.microsoft.com/Forums/en-US/0f9fec02-4469-4c56-92ec-00d46b26b3fc/how-to-automateparameterizeloop-power-query?forum=powerquery">Первая ссылка в выдаче</a> и комментарии к материалу содержат наш вопрос и ответ на него.<br /></div></div></div></div></div></div><div id="rec209964446" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">let  
Election.Results = (state) =&gt; let    
Source = Web.Page(Web.Contents(&quot;http://en.wikipedia.org/wiki/&quot; &amp; state)),  
Data5 = Source{[Caption=&quot;Presidential elections results&quot;]}[Data],  
ChangedType = Table.TransformColumnTypes(Data5,{{&quot;Year&quot;, type number}, {&quot;Republican&quot;, type text}, 
{&quot;Democratic&quot;, type text}})  
in  
ChangedType,  
States = Table.FromRows({{&quot;California&quot;}, {&quot;Idaho&quot;}, {&quot;Massachusetts&quot;}}, {&quot;State&quot;}),  
InsertedCustom = Table.AddColumn(States, &quot;Custom&quot;, each Election.Results([State])),  
#&quot;Expand Custom&quot; = Table.ExpandTableColumn(InsertedCustom, &quot;Custom&quot;, 
{&quot;Year&quot;, &quot;Republican&quot;, &quot;Democratic&quot;}, {&quot;Year&quot;, &quot;Republican&quot;, &quot;Democratic&quot;})  
in  
#&quot;Expand Custom&quot;</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec209965339" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">По аналогии попробуем сделать то же самое с нашими запросами к API UniSender: <br /><br /> Создадим новый пустой запрос.<br /></div></div></div></div></div></div><div id="rec209965526" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild3133-3332-4736-b439-616138653562__-__empty__0bfa9f6ecb.png" data-original="images/tild3133-3332-4736-b439-616138653562__0bfa9f6ecb.png" imgfield="img" /><meta itemprop="image" content="images/tild3133-3332-4736-b439-616138653562__0bfa9f6ecb.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec209965574" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Исходные данные, включая id кампаний, которые будут аргументами функции цикла, мы получаем с помощью кода запроса Campaigns, значит, мы берём код этого запроса и дорабатываем его вручную. Для лучшего восприятия кода переименуем автоматически созданную переменную «Changed Type» в Campaigns. <br /><br /> Реализация цикла будет выглядеть так:<br /></div></div></div></div></div></div><div id="rec209965819" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">campaignsWithStat = Table.AddColumn(Campaigns, &quot;stat&quot;, each getStat([id]))</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec209966060" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Код нашего запроса CampaignCommonStats будет выполняться внутри функции getStat цикла. Аргументом функции будет id кампании. Проверяем. Всё получается! <br /><br /> Теперь сделаем так, чтобы функция getStat возвращала табличные данные. Подставляем полученный код в наш запрос. <br /><br /> Мы получили в новом столбце таблицы, но при попытке раскрыть данные, мы видим, что Power BI предлагает получить новые столбцы Name и Value. Это не совсем то, что нам надо. Нам в таблице нужны значения total, sent, delivered и т.д. Чтобы получить желаемый результат, надо транспонировать результат выполнения функции getStat и использовать бывшие ключи в качестве заголовков. <br /><br /> Всё это можно сделать через интерфейс Query Editor: выбираем запрос CampaignCommonStats и в ленте инструментов нажимаем<br />1. Transform → Transpose,<br />2. Home → Use First Row As Headers. <br /><br /> Получившийся код запроса CampaignCommonStats вставляем в функцию getStat. Теперь добавленный столбец stat можно раскрыть.<br /></div></div></div></div></div></div><div id="rec209966347" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild3233-3531-4563-b363-383332343935__-__empty__3c2ade19f9.png" data-original="images/tild3233-3531-4563-b363-383332343935__3c2ade19f9.png" imgfield="img" /><meta itemprop="image" content="images/tild3233-3531-4563-b363-383332343935__3c2ade19f9.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec209966445" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Переименуем наш новый запрос в allCampaigns. В конечном виде должен получиться примерно такой код запроса allCampaigns:</div></div></div></div></div></div><div id="rec209966625" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">let // Функция, которая будет циклически выполняться  
getStat = (campaignId) =&gt; let  
Source = Json.Document(Web.Contents(&quot;http://api.unisender.com/ru/api/getCampaignCommonStats?format=  
json&amp;api_key=5tmjbcir5g4xuew573mxcoh4ypo98xbbbadqgs4a&amp;campaign_id=&quot; &amp; campaignId)),  
result = Source[result],  
#&quot;Converted to Table&quot; = Record.ToTable(result),  
#&quot;Transposed Table&quot; = Table.Transpose(#&quot;Converted to Table&quot;),  
#&quot;Promoted Headers&quot; = Table.PromoteHeaders(#&quot;Transposed Table&quot;)  
in  
#&quot;Promoted Headers&quot;,  
Source = Json.Document(Web.Contents(&quot;http://api.unisender.com/ru/api/getCampaigns?format=  
json&amp;api_key=5tmjbcir5g4xuew573mxcoh4ypo98xbbbadqgs4a&quot;)), result = Source[result],  
#&quot;Converted to Table&quot; = Table.FromList(result, Splitter.SplitByNothing(), null, null, ExtraValues.Error),  
#&quot;Expanded Column1&quot; = Table.ExpandRecordColumn(#&quot;Converted to Table&quot;, &quot;Column1&quot;,  
{&quot;id&quot;, &quot;start_time&quot;, &quot;status&quot;, &quot;message_id&quot;, &quot;list_id&quot;, &quot;subject&quot;, &quot;sender_name&quot;, &quot;sender_email&quot;,  
&quot;stats_url&quot;},  
{&quot;id&quot;, &quot;start_time&quot;, &quot;status&quot;, &quot;message_id&quot;, &quot;list_id&quot;, &quot;subject&quot;, &quot;sender_name&quot;, &quot;sender_email&quot;, &quot;stats_url&quot;}),  
Campaigns = Table.TransformColumnTypes(#&quot;Expanded Column1&quot;,{{&quot;id&quot;, type text},  
{&quot;start_time&quot;, type datetime}, {&quot;status&quot;, type text}, {&quot;message_id&quot;, Int64.Type},  
{&quot;list_id&quot;, Int64.Type}, {&quot;subject&quot;, type text}, {&quot;sender_name&quot;, type text},  
{&quot;sender_email&quot;, type text}, {&quot;stats_url&quot;, type text}}),  
campaignsWithStat = Table.AddColumn(Campaigns, &quot;stat&quot;, each getStat([id])),  
#&quot;Expanded stat&quot; = Table.ExpandTableColumn(campaignsWithStat, &quot;stat&quot;,  
{&quot;total&quot;, &quot;sent&quot;, &quot;delivered&quot;, &quot;read_unique&quot;, &quot;read_all&quot;, &quot;clicked_unique&quot;, &quot;clicked_all&quot;, &quot;unsubscribed&quot;, &quot;spam&quot;},  
{&quot;total&quot;, &quot;sent&quot;, &quot;delivered&quot;, &quot;read_unique&quot;, &quot;read_all&quot;, &quot;clicked_unique&quot;, &quot;clicked_all&quot;, &quot;unsubscribed&quot;, &quot;spam&quot;})  
in  
#&quot;Expanded stat&quot;</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec209957048" class="r t-rec t-rec_pt_0 t-rec_pb_120" style="padding-top:0px;padding-bottom:120px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Сохраним проект в текущем состоянии. <br /><br /> Итак, мы прошли половину пути. В следующий части мы получим недостающие данные по подписчикам, обработаем все данные, соберем из них красивый отчет и опубликуем его в сети. В комментариях мы ответим на любые вопросы по материалу.<br />Конец первой части.<br /></div></div></div></div></div></div></div><!--/allrecords-->