<!--allrecords--><div id="allrecords" data-tilda-export="yes" class="t-records" data-hook="blocks-collection-content-node" data-tilda-project-id="14542" data-tilda-page-id="12601850" data-tilda-page-alias="blog/budget_by_calendar" data-tilda-formskey="2bb761110255242a2bbb1bf3f837b680" data-tilda-lazy="yes" data-tilda-project-headcode="yes"><!--header--><div id="t-header" class="t-records" data-hook="blocks-collection-content-node" data-tilda-project-id="14542" data-tilda-page-id="61936" data-tilda-page-alias="header" data-tilda-formskey="2bb761110255242a2bbb1bf3f837b680" data-tilda-project-headcode="yes"></div><!--/header--><div id="rec210275641" class="r t-rec" style=" " data-animationappear="off" data-record-type="891" ><!-- cover --><div class="t-cover" id="recorddiv210275641" bgimgfield="img" style="height:450px; background-image:-webkit-linear-gradient(top, #ccc, #777); background-image:-moz-linear-gradient(top, #ccc, #777); background-image:-o-linear-gradient(top, #ccc, #777); background-image:-ms-linear-gradient(top, #ccc, #777); background-image:linear-gradient(top, #ccc, #777); " ><div class="t-cover__carrier" id="coverCarry210275641" data-content-cover-id="210275641" data-content-cover-bg="" data-content-cover-height="450px" data-content-cover-parallax="" style="height:450px;background-attachment:scroll; "></div> <div class="t-cover__filter" style="height:450px;background-image: -moz-linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));background-image: -webkit-linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));background-image: -o-linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));background-image: -ms-linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));background-image: linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));filter: progid:DXImageTransform.Microsoft.gradient(startColorStr='#000e1f2f', endColorstr='#00182d42');"></div><div class="t891"> <div class="t-container"> <div class="t-col t-col_12"> <div class="t-cover__wrapper t-valign_middle" style="height:450px;"> <div class="t891__wrapper" data-hook-content="covercontent"> <div class="t891__title t-title t-title_xl" style="padding-top:100px;text-shadow: 0px 2px 5px rgba(0, 0, 0, 0.0);" field="title"><div style="font-size:46px;text-align:left;" data-customstyle="yes">Бюджетирование величины<br /> по календарю в Power Query<br /></div></div> <div class="t891__descr t-descr t-descr_xl " style="" field="descr"><div style="font-size:18px;text-align:left;" data-customstyle="yes">Текст представляет собой адаптированный перевод статьи Криса Вебба, оригинал – <a href="https://blog.crossjoin.co.uk/2014/02/24/allocation-in-power-query/">Allocation in Power Query</a>.<br /> Рассматривается англоязычный Power Query.<em></em><br /></div></div> <span class="space"></span> </div> </div> </div> </div></div> </div> </div><div id="rec210275642" class="r t-rec t-rec_pt_90 t-rec_pb_15" style="padding-top:90px;padding-bottom:15px; " data-record-type="296" ><!-- t265 --><div class="t265"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t265__wrapper" style="background:#fafafa;"> <div class="t265__icon"> <svg x="0px" y="0px" width="24px" height="24px" viewBox="0 0 24 24" style="enable-background:new 0 0 24 24;"> <circle style="fill:#edbd11;" cx="12.125" cy="12.125" r="12"/> <g> <path style="fill:#ffffff;" d="M10.922,6.486c0-0.728,0.406-1.091,1.217-1.091s1.215,0.363,1.215,1.091c0,0.347-0.102,0.617-0.304,0.81 c-0.202,0.193-0.507,0.289-0.911,0.289C11.328,7.585,10.922,7.219,10.922,6.486z M13.252,17.792h-2.234V9.604h2.234V17.792z"/> </g> </svg> </div> <div class="t265__text t-descr t-descr_xs" style="color:#000000;" field="text"><div style="font-size:14px;" data-customstyle="yes"><a href="https://blog.crossjoin.co.uk/" style="color:rgb(0, 0, 0) !important;">Крис Вебб</a> (Chris Webb) — независимый эксперт, консультант по технологиям Analysis Services, MDX, Power Pivot, DAX, Power Query и Power BI. Его блог — это кладезь информации на тему перечисленных технологий. Вот уже более 10 лет он пишет про BI-решения от Microsoft. Количество его статей перевалило за 1000! Также Крис выступает на большом количестве различных конференций вроде SQLBits, PASS Summit, PASS BA Conference, SQL Saturdays и участвует в различных сообществах.<br />Крис любезно разрешил нам переводить его статьи на русский язык. И это одна из них.</div></div> </div> </div> </div></div></div><div id="rec210275644" class="r t-rec t-rec_pt_15 t-rec_pb_0" style="padding-top:15px;padding-bottom:0px; " data-record-type="128" ><!-- T120 --><div class="t120"> <div class="t-container t-align_left"> <div class="t-col t-col_8 t-prefix_2"> <h3 class="t120__title t-heading t-heading_sm" field="title" style="font-size:16px;">Бюджетирование величины по календарю в Power Query<br /></h3> </div> </div></div></div><div id="rec210275645" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Все, кто сегодня занимается бизнес-анализом, да и любой, изучающий Excel, рано или поздно приходят на сайт Bill Jelen (Билл Джелен, он же Mr Excel). У него есть <a href="http://www.mrexcel.com/learnexcel/2014/02/24/dueling-excel-split-a-contract-over-n-months-podcast-1860/">очень интересный подкаст</a> о разделении стоимости контракта на N месяцев. Интересен он не только тем, что подобные задачи встречались при работе с реальными клиентами, но и потому, что отбор нужных данных в Power Query – то, о чём мы часто пишем в своих статьях. <br /><br /> В этой статье мы собираемся взять те же данные, что и в подкасте Bill и Mike Girvin (Майк Гирвин – автор книги <a href="https://www.amazon.co.uk/gp/product/1615470077/ref=as_li_ss_tl?ie=UTF8&amp;camp=1634&amp;creative=19450&amp;creativeASIN=1615470077&amp;linkCode=as2&amp;tag=chriswebbsbib-21">Формулы массивов в Excel</a>), и показать как получить аналогичные с ними результаты в Power Query и Power Pivot. <br /><br /> Для начала, сделаем в Excel две таблицы — Contract и Month:<br /></div></div></div></div></div></div><div id="rec210275646" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild6239-3166-4663-b534-316463626364__-__empty__p1-1.png" data-original="images/tild6239-3166-4663-b534-316463626364__p1-1.png" imgfield="img" /><meta itemprop="image" content="images/tild6239-3166-4663-b534-316463626364__p1-1.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec210275647" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Конечно, это не тот же макет, что в подкасте, но так сделано сознательно. Мы хотим держать отдельно источник данных и результат (он может быть PivotTable, куб-формулами или таблицей Power View). <br /><br /> Далее импортируем таблицу Month table в Power Query, используя кнопку From Table, и добавляем столбец индексов, выбрав пункт Add Index. Должно получиться так:<br /></div></div></div></div></div></div><div id="rec210275648" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild3135-3837-4539-b334-366266313262__-__empty__p2-1.png" data-original="images/tild3135-3837-4539-b334-366266313262__p2-1.png" imgfield="img" /><meta itemprop="image" content="images/tild3135-3837-4539-b334-366266313262__p2-1.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec210275649" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Нам не нужно никуда загружать эту таблицу, хотя результат понадобится в следующем запросе. Поэтому снимем оба флажка секции Load Settings в Query Editor и вернёмся к листу:</div></div></div></div></div></div><div id="rec210275650" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild6662-3635-4164-a333-343032366536__-__empty__p3-1.png" data-original="images/tild6662-3635-4164-a333-343032366536__p3-1.png" imgfield="img" /><meta itemprop="image" content="images/tild6662-3635-4164-a333-343032366536__p3-1.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec210275651" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Импортируем таблицу Contract и добавляем столбец индексов:</div></div></div></div></div></div><div id="rec210276720" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild3862-3737-4234-a135-623336393737__-__empty__p4.png" data-original="images/tild3862-3737-4234-a135-623336393737__p4.png" imgfield="img" /><meta itemprop="image" content="images/tild3862-3737-4234-a135-623336393737__p4.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec210276812" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Теперь добавляем пользовательский столбец, в котором определяем ежемесячную сумму, разделив столбец Contract Amount на Months In Contract:</div></div></div></div></div></div><div id="rec210277025" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild6666-3966-4137-a638-653936336333__-__empty__p5.png" data-original="images/tild6666-3966-4137-a638-653936336333__p5.png" imgfield="img" /><meta itemprop="image" content="images/tild6666-3966-4137-a638-653936336333__p5.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec210277060" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Мы подобрались к интересному моменту. Вставляем ещё один пользовательский столбец и вводим такой код для него: <br /><br /> Table.FirstN(Month, [Months In Contract]) <br /><br /> Каждая строка этого столбца содержит первые N строк таблицы Month, где N выбирается из столбца [Months In Contract]. На выходе получим:<br /></div></div></div></div></div></div><div id="rec210277153" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild3037-6361-4132-b430-633865363437__-__empty__p6.png" data-original="images/tild3037-6361-4132-b430-633865363437__p6.png" imgfield="img" /><meta itemprop="image" content="images/tild3037-6361-4132-b430-633865363437__p6.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec210277190" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Нажмём на значок "Развернуть" в заголовке столбца, чтобы повторить строки контракта на соответствующее количество месяцев. <br /><br /> Переименуем столбцы, установим типы данных и можно загружать результат в модель данных эксель.<br /></div></div></div></div></div></div><div id="rec210277294" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild3735-3561-4161-b363-353033633431__-__empty__p7.png" data-original="images/tild3735-3561-4161-b363-353033633431__p7.png" imgfield="img" /><meta itemprop="image" content="images/tild3735-3561-4161-b363-353033633431__p7.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec210277358" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Весь код для обоих запросов:</div></div></div></div></div></div><div id="rec210275652" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">--Month Query    
let  
     Source = Excel.CurrentWorkbook(){[Name=&quot;Month&quot;]}[Content],  
     InsertedIndex = Table.AddIndexColumn(Source,&quot;Index&quot;),  
     ReorderedColumns = Table.ReorderColumns(InsertedIndex,{&quot;Index&quot;, &quot;Month&quot;})  
in  
     ReorderedColumns  
--Contract Query  
let  
     Source = Excel.CurrentWorkbook(){[Name=&quot;Contract&quot;]}[Content],  
     InsertedIndex = Table.AddIndexColumn(Source,&quot;Index&quot;),  
     RenamedColumns = Table.RenameColumns(InsertedIndex,{{&quot;Index&quot;, &quot;ContractID&quot;}}),  
     ReorderedColumns = Table.ReorderColumns(RenamedColumns,{&quot;ContractID&quot;,  
          &quot;Months In Contract&quot;, &quot;Contract Amount&quot;}),  
     InsertedCustom = Table.AddColumn(ReorderedColumns, &quot;Allocated Amount&quot;,  
          each [Contract Amount]/[Months In Contract]),  
     InsertedCustom1 = Table.AddColumn(InsertedCustom, &quot;Custom&quot;,  
          each Table.FirstN(Month, [Months In Contract])),  
# &quot;Expand Custom&quot; = Table.ExpandTableColumn(InsertedCustom1, &quot;Custom&quot;,  
          {&quot;Index&quot;, &quot;Month&quot;}, {&quot;Custom.Index&quot;, &quot;Custom.Month&quot;}),  
     RenamedColumns1 = Table.RenameColumns(#&quot;Expand Custom&quot;,{{&quot;Custom.Index&quot;, &quot;MonthID&quot;},  
          {&quot;Custom.Month&quot;, &quot;Month&quot;}}),  
     ChangedType = Table.TransformColumnTypes(RenamedColumns1,{{&quot;Allocated Amount&quot;, type number},  
          {&quot;Contract Amount&quot;, type number}, {&quot;MonthID&quot;, type number},  
          {&quot;Months In Contract&quot;, type number}, {&quot;ContractID&quot;, type number}})  
in  
     ChangedType</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec210277570" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes"> Наконец перейдём к окну Power Pivot и сделаем две вещи: <br /><br /> <ul> <li> Отсортируем столбец Month по столбцу MonthID </li> <li> Отформатируем столбец Allocated Amount знаком доллара </li> </ul> Готово! Теперь можно создать сводную таблицу с нужными данными:<br /></div></div></div></div></div></div><div id="rec210277739" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild3364-3335-4866-b433-333837356562__-__empty__p8.png" data-original="images/tild3364-3335-4866-b433-333837356562__p8.png" imgfield="img" /><meta itemprop="image" content="images/tild3364-3335-4866-b433-333837356562__p8.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec210278007" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Может быть, это более длинный путь, чем в примерах Билла или Майка, но вряд ли сложнее. К тому же, наши данные в модели данных Excel позволяют делать их презентацию более гибкой. Например, можно воспользоваться Power View без необходимости что-либо менять в самой модели или формулах:</div></div></div></div></div></div><div id="rec210278244" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild3432-3966-4432-b533-383037333866__-__empty__p9.png" data-original="images/tild3432-3966-4432-b533-383037333866__p9.png" imgfield="img" /><meta itemprop="image" content="images/tild3432-3966-4432-b533-383037333866__p9.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec210275653" class="r t-rec t-rec_pt_0 t-rec_pb_120" style="padding-top:0px;padding-bottom:120px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Авторы отошли от устоявшейся практики отделять таблицу дат от Power Pivot, чтобы не уходить от изначальных примеров.</div></div></div></div></div></div></div><!--/allrecords-->