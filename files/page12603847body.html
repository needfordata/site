<!--allrecords--><div id="allrecords" data-tilda-export="yes" class="t-records" data-hook="blocks-collection-content-node" data-tilda-project-id="14542" data-tilda-page-id="12603847" data-tilda-page-alias="blog/manipulyacii-s-dobavlennymi-ili-udalennymi-stolbcami-v-power-query" data-tilda-formskey="2bb761110255242a2bbb1bf3f837b680" data-tilda-lazy="yes" data-tilda-project-headcode="yes"><!--header--><div id="t-header" class="t-records" data-hook="blocks-collection-content-node" data-tilda-project-id="14542" data-tilda-page-id="61936" data-tilda-page-alias="header" data-tilda-formskey="2bb761110255242a2bbb1bf3f837b680" data-tilda-project-headcode="yes"></div><!--/header--><div id="rec210308440" class="r t-rec" style=" " data-animationappear="off" data-record-type="891" ><!-- cover --><div class="t-cover" id="recorddiv210308440" bgimgfield="img" style="height:450px; background-image:-webkit-linear-gradient(top, #ccc, #777); background-image:-moz-linear-gradient(top, #ccc, #777); background-image:-o-linear-gradient(top, #ccc, #777); background-image:-ms-linear-gradient(top, #ccc, #777); background-image:linear-gradient(top, #ccc, #777); " ><div class="t-cover__carrier" id="coverCarry210308440" data-content-cover-id="210308440" data-content-cover-bg="" data-content-cover-height="450px" data-content-cover-parallax="" style="height:450px;background-attachment:scroll; "></div> <div class="t-cover__filter" style="height:450px;background-image: -moz-linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));background-image: -webkit-linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));background-image: -o-linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));background-image: -ms-linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));background-image: linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));filter: progid:DXImageTransform.Microsoft.gradient(startColorStr='#000e1f2f', endColorstr='#00182d42');"></div><div class="t891"> <div class="t-container"> <div class="t-col t-col_12"> <div class="t-cover__wrapper t-valign_middle" style="height:450px;"> <div class="t891__wrapper" data-hook-content="covercontent"> <div class="t891__title t-title t-title_xl" style="padding-top:100px;text-shadow: 0px 2px 5px rgba(0, 0, 0, 0.0);" field="title"><div style="font-size:46px;text-align:left;" data-customstyle="yes">Манипуляции с добавленными<br /> или удаленными столбцами в Power Query<br /></div></div> <div class="t891__descr t-descr t-descr_xl " style="" field="descr"><div style="font-size:18px;text-align:left;" data-customstyle="yes">Текст представляет собой адаптированный перевод статьи Криса Вебба (Chris Webb), <br />оригинал — <a href="https://blog.crossjoin.co.uk/2015/02/26/handling-added-or-missing-columns-in-power-query/">Handling Added Or Missing Columns In Power Query</a>. <br />Рассматривается англоязычный Power Query.</div></div> <span class="space"></span> </div> </div> </div> </div></div> </div> </div><div id="rec210308441" class="r t-rec t-rec_pt_90 t-rec_pb_15" style="padding-top:90px;padding-bottom:15px; " data-record-type="296" ><!-- t265 --><div class="t265"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t265__wrapper" style="background:#fafafa;"> <div class="t265__icon"> <svg x="0px" y="0px" width="24px" height="24px" viewBox="0 0 24 24" style="enable-background:new 0 0 24 24;"> <circle style="fill:#edbd11;" cx="12.125" cy="12.125" r="12"/> <g> <path style="fill:#ffffff;" d="M10.922,6.486c0-0.728,0.406-1.091,1.217-1.091s1.215,0.363,1.215,1.091c0,0.347-0.102,0.617-0.304,0.81 c-0.202,0.193-0.507,0.289-0.911,0.289C11.328,7.585,10.922,7.219,10.922,6.486z M13.252,17.792h-2.234V9.604h2.234V17.792z"/> </g> </svg> </div> <div class="t265__text t-descr t-descr_xs" style="color:#000000;" field="text"><div style="font-size:14px;" data-customstyle="yes"><a href="https://blog.crossjoin.co.uk/" style="color:rgb(0, 0, 0) !important;">Крис Вебб</a> (Chris Webb) — независимый эксперт, консультант по технологиям Analysis Services, MDX, Power Pivot, DAX, Power Query и Power BI. Его блог — это кладезь информации на тему перечисленных технологий. Вот уже более 10 лет он пишет про BI-решения от Microsoft. Количество его статей перевалило за 1000! Также Крис выступает на большом количестве различных конференций вроде SQLBits, PASS Summit, PASS BA Conference, SQL Saturdays и участвует в различных сообществах.<br />Крис любезно разрешил нам переводить его статьи на русский язык. И это одна из них.</div></div> </div> </div> </div></div></div><div id="rec210308443" class="r t-rec t-rec_pt_15 t-rec_pb_0" style="padding-top:15px;padding-bottom:0px; " data-record-type="128" ><!-- T120 --><div class="t120"> <div class="t-container t-align_left"> <div class="t-col t-col_8 t-prefix_2"> <h3 class="t120__title t-heading t-heading_sm" field="title" style="font-size:16px;">Манипуляции с добавленными или удаленными столбцами в Power Query<br /></h3> </div> </div></div></div><div id="rec210308444" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Сегодня мы рассмотрим тему обработки столбцов, которые были добавлены или удалены в источнике данных Power Query. Любой, кто работал с csv-файлами знает, что они имеют неприятное свойство менять свою структуру, даже если это не предполагалось изначально. Неожиданное добавление или удаление столбцов приносит немало проблем при дальнейшей обработке. <br /><br /> Ken Puls в своём <a href="https://www.excelguru.ca/blog/">блоге</a> показывает, как легко защититься от новых столбцов в источнике данных. При создании запроса выделите все нужные столбцы, нажмите ПКМ и выберите пункт Remove Other Columns (Удалить другие столбцы):<br /></div></div></div></div></div></div><div id="rec210309059" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild6336-6465-4930-a535-633134396565__-__empty__p1.png" data-original="images/tild6336-6465-4930-a535-633134396565__p1.png" imgfield="img" /><meta itemprop="image" content="images/tild6336-6465-4930-a535-633134396565__p1.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec210309255" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Это означает, что если появятся какие-либо новые столбцы в источнике данных, то их не будет в результатах запроса. В коде для этого используют функцию Table.SelectColumns() function. <br /><br /> Работа с удалёнными столбцами несколько сложнее. Прежде всего, нам потребуется список столбцов, которые должны присутствовать в запросе. Его можно вручную создать на листе Excel, или получить через запрос к источнику данных с помощью функции Table.ColumnNames():<br /></div></div></div></div></div></div><div id="rec210308445" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">let
    //Подключение к файлу to CSV
    Source = Csv.Document(
                      File.Contents(
                       &quot;C:\Users\Chris\Documents\Power Query demos\SampleData.csv&quot;
                      ),null,&quot;,&quot;,null,1252),
    //Первая строка - заголовки
    FirstRowAsHeader = Table.PromoteHeaders(Source),
    // Получаем список имён столбцов
    GetColumns = Table.ColumnNames(FirstRowAsHeader),
    //Преобразуем список в таблицу
    MakeATable = Table.FromList(
                              GetColumns,
                              Splitter.SplitByNothing(),
                              null,
                              null,
                              ExtraValues.Error),
    //Переименуем единственный столбец таблицы
    RenamedColumns = Table.RenameColumns(
                                         MakeATable ,
                                         {{&quot;Column1&quot;, &quot;ColumnName&quot;}})
in
    RenamedColumns</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec210308446" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Наш csv-файл выглядит так:</div></div></div></div></div></div><div id="rec210309967" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild3231-3762-4664-b763-356330653237__-__empty__p2.png" data-original="images/tild3231-3762-4664-b763-356330653237__p2.png" imgfield="img" /><meta itemprop="image" content="images/tild3231-3762-4664-b763-356330653237__p2.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec210310093" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Запрос вернёт такую таблицу:</div></div></div></div></div></div><div id="rec210310201" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild6635-6634-4037-b933-313432366537__-__empty__p3.png" data-original="images/tild6635-6634-4037-b933-313432366537__p3.png" imgfield="img" /><meta itemprop="image" content="images/tild6635-6634-4037-b933-313432366537__p3.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec210310233" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Затем можно сохранить результаты запроса на лист Excel для дальнейшего использования. Только не обновляйте запрос! <br /><br /> Имея список ожидаемых имён, сравним его со списком столбцов источника данных. Например так:<br /></div></div></div></div></div></div><div id="rec210310399" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">let  
      //Подключаемся к таблице со списком имён столбцов  
      ExcelSource = Excel.CurrentWorkbook(){[Name=&quot;GetColumnNames&quot;]}[Content],  
      //Получаем список  
      ExpectedColumns = Table.Column(ExcelSource, &quot;ColumnName&quot;),  
      //Подключаемся к файлу CSV  
      CSVSource = Csv.Document(  
            File.Contents(  
               &quot;C:\Users\Chris\Documents\Power Query demos\SampleData.csv&quot;  
               ),null,&quot;,&quot;,null,1252),  
      //Первая строка - заголовки  
      FirstRowAsHeader = Table.PromoteHeaders(CSVSource),  
      //Получаем список заголовков файла csv  
      CSVColumns = Table.ColumnNames(FirstRowAsHeader),  
      //Ищем удалённые столбцы  
      MissingColumns = List.Difference(ExpectedColumns, CSVColumns),  
      //Ищем добавленные столбцы  
      AddedColumns = List.Difference(CSVColumns, ExpectedColumns),  
      //Все изменения  
      OutputMissing = if List.Count(MissingColumns)=0 then  
            &quot;No columns missing&quot; else  
            &quot;Missing columns: &quot; &amp; Text.Combine(MissingColumns, &quot;,&quot;),  
      OutputAdded = if List.Count(AddedColumns)=0 then  
            &quot;No columns added&quot; else  
            &quot;Added columns: &quot; &amp; Text.Combine(AddedColumns, &quot;,&quot;),  
      Output = OutputMissing &amp; &quot; &quot; &amp; OutputAdded  
   in  
      Output</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec210310593" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Структура тестового файла:</div></div></div></div></div></div><div id="rec210310778" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild6635-6634-4037-b933-313432366537__-__empty__p3.png" data-original="images/tild6635-6634-4037-b933-313432366537__p3.png" imgfield="img" /><meta itemprop="image" content="images/tild6635-6634-4037-b933-313432366537__p3.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec210311387" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Если таблица Excel содержит имена Month, Product и Sales, то запрос вернёт:</div></div></div></div></div></div><div id="rec210311349" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild6136-3131-4964-b536-313335386336__-__empty__p5.png" data-original="images/tild6136-3131-4964-b536-313335386336__p5.png" imgfield="img" /><meta itemprop="image" content="images/tild6136-3131-4964-b536-313335386336__p5.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec210310922" class="r t-rec t-rec_pt_0 t-rec_pb_120" style="padding-top:0px;padding-bottom:120px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Легко преобразовать данный запрос в функцию, чтобы использовать в других запросах для проверки столбцов. Формат выходных данных также несложно адаптировать под свои нужды. Иногда требуется проверка типов данных, это мы оставим для одной из следующих статей. <br /><br /> В любом случае, типы данных не составляют проблему при работе с файлами CSV. Power Query вводит для столбцов в запросе тип данных столбца, а все преобразования типов можно отследить с помощью обработчика ошибок.<br /></div></div></div></div></div></div></div><!--/allrecords-->