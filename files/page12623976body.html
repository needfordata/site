<!--allrecords--><div id="allrecords" data-tilda-export="yes" class="t-records" data-hook="blocks-collection-content-node" data-tilda-project-id="14542" data-tilda-page-id="12623976" data-tilda-page-alias="blog/caching-and-excludedfromcachekey-option-in-power-bi-and-power-query" data-tilda-formskey="2bb761110255242a2bbb1bf3f837b680" data-tilda-lazy="yes" data-tilda-project-headcode="yes"><!--header--><div id="t-header" class="t-records" data-hook="blocks-collection-content-node" data-tilda-project-id="14542" data-tilda-page-id="61936" data-tilda-page-alias="header" data-tilda-formskey="2bb761110255242a2bbb1bf3f837b680" data-tilda-project-headcode="yes"></div><!--/header--><div id="rec210608320" class="r t-rec" style=" " data-animationappear="off" data-record-type="891" ><!-- cover --><div class="t-cover" id="recorddiv210608320" bgimgfield="img" style="height:450px; background-image:-webkit-linear-gradient(top, #ccc, #777); background-image:-moz-linear-gradient(top, #ccc, #777); background-image:-o-linear-gradient(top, #ccc, #777); background-image:-ms-linear-gradient(top, #ccc, #777); background-image:linear-gradient(top, #ccc, #777); " ><div class="t-cover__carrier" id="coverCarry210608320" data-content-cover-id="210608320" data-content-cover-bg="" data-content-cover-height="450px" data-content-cover-parallax="" style="height:450px;background-attachment:scroll; "></div> <div class="t-cover__filter" style="height:450px;background-image: -moz-linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));background-image: -webkit-linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));background-image: -o-linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));background-image: -ms-linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));background-image: linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));filter: progid:DXImageTransform.Microsoft.gradient(startColorStr='#000e1f2f', endColorstr='#00182d42');"></div><div class="t891"> <div class="t-container"> <div class="t-col t-col_12"> <div class="t-cover__wrapper t-valign_middle" style="height:450px;"> <div class="t891__wrapper" data-hook-content="covercontent"> <div class="t891__title t-title t-title_xl" style="padding-top:100px;text-shadow: 0px 2px 5px rgba(0, 0, 0, 0.0);" field="title"><div style="font-size:46px;text-align:left;" data-customstyle="yes">Функция Web.Contents() и её параметры Caching и ExcludedFromCacheKey в Power BI и Power Query<br /></div></div> <div class="t891__descr t-descr t-descr_xl " style="" field="descr"><div style="font-size:18px;text-align:left;" data-customstyle="yes">Текст представляет собой адаптированный перевод статьи Chris Webb (Крис Уэбб), <br />оригинал — <a href="https://blog.crossjoin.co.uk/2017/01/06/web-contents-caching-and-the-excludedfromcachekey-option-in-power-bi-and-power-query/">Web.Contents(), Caching And The ExcludedFromCacheKey Option In Power BI And Power Query</a>.</div></div> <span class="space"></span> </div> </div> </div> </div></div> </div> </div><div id="rec210608321" class="r t-rec t-rec_pt_90 t-rec_pb_15" style="padding-top:90px;padding-bottom:15px; " data-record-type="296" ><!-- t265 --><div class="t265"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t265__wrapper" style="background:#fafafa;"> <div class="t265__icon"> <svg x="0px" y="0px" width="24px" height="24px" viewBox="0 0 24 24" style="enable-background:new 0 0 24 24;"> <circle style="fill:#edbd11;" cx="12.125" cy="12.125" r="12"/> <g> <path style="fill:#ffffff;" d="M10.922,6.486c0-0.728,0.406-1.091,1.217-1.091s1.215,0.363,1.215,1.091c0,0.347-0.102,0.617-0.304,0.81 c-0.202,0.193-0.507,0.289-0.911,0.289C11.328,7.585,10.922,7.219,10.922,6.486z M13.252,17.792h-2.234V9.604h2.234V17.792z"/> </g> </svg> </div> <div class="t265__text t-descr t-descr_xs" style="color:#000000;" field="text"><div style="font-size:14px;" data-customstyle="yes"><a href="https://blog.crossjoin.co.uk/" style="color:rgb(0, 0, 0) !important;">Крис Вебб</a> (Chris Webb) — независимый эксперт, консультант по технологиям Analysis Services, MDX, Power Pivot, DAX, Power Query и Power BI. Его блог — это кладезь информации на тему перечисленных технологий. Вот уже более 10 лет он пишет про BI-решения от Microsoft. Количество его статей перевалило за 1000! Также Крис выступает на большом количестве различных конференций вроде SQLBits, PASS Summit, PASS BA Conference, SQL Saturdays и участвует в различных сообществах.<br />Крис любезно разрешил нам переводить его статьи на русский язык. И это одна из них.</div></div> </div> </div> </div></div></div><div id="rec210608323" class="r t-rec t-rec_pt_15 t-rec_pb_0" style="padding-top:15px;padding-bottom:0px; " data-record-type="128" ><!-- T120 --><div class="t120"> <div class="t-container t-align_left"> <div class="t-col t-col_8 t-prefix_2"> <h3 class="t120__title t-heading t-heading_sm" field="title" style="font-size:16px;">Функция Web.Contents() и её параметры Caching и ExcludedFromCacheKey в Power BI и Power Query<br /></h3> </div> </div></div></div><div id="rec210608324" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">При использовании функции <em>Web.Contents()</em> для вызова веб-сервиса из Power Query или Power BI нет необходимости получать HTTP запрос при каждом вызове функции. Происходит кэширование, и нет нужды вызывать запрос снова и снова для получения одних и тех же данных. В этой статье мы предоставим результаты тестов, показывающие как работает кэширование в <em>Web.Contents()</em> и какие факторы влияют на это. <br /><br /> Для тестов мы создали веб-сервис в Microsoft Flow, подобно тому, что мы описывали ранее. Он принимает HTTP POST запрос и вызывает процедуру сохранения в базе данных Azure SQL. Процедура сохранения обновляет таблицу базы, что позволяет, в свою очередь, подсчитать количество вызовов сервиса. Если процедура прошла удачно, он вернёт 0. <br /><br /> Этот сервис можно затем вызвать из Power Query или Power BI при помощи функции <em>Web.Contents()</em>. Примерно вот так (поскольку URL слишком длинный, он сохранён в переменной <em>WebServiceURL</em>):<br /></div></div></div></div></div></div><div id="rec210608325" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">Let
      Source = Web.Contents(
      WebServiceURL,
      [Content=Text.ToBinary(&quot;Hello&quot;)]
      ),
      #&quot;Imported JSON&quot; = Json.Document(Source,1252)
   in
      #&quot;Imported JSON&quot;</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec210608326" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">При запуске Power Query результат запроса выводится в таблицу Excel:</div></div></div></div></div></div><div id="rec210608327" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild3164-3231-4064-b666-393535633535__-__empty__image1.png" data-original="images/tild3164-3231-4064-b666-393535633535__image1.png" imgfield="img" /><meta itemprop="image" content="images/tild3164-3231-4064-b666-393535633535__image1.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec210608328" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Основная важная вещь, которую стоит отметить, — это то, что в последних версиях Power Query (у нас Excel 2016 build 7571.2109) и Power BI (релиз 2.41.4581.361 – November 2016) при обновлении запроса веб-сервис вызывается один раз. Это кажется очевидным, но в предыдущих версиях вызовы происходили несколько раз… <br /><br /> Теперь посмотрим пример, где запрос вызывает веб-сервис несколько раз. Ниже приведен запрос, преобразованный в функцию fnCallWebService:<br /></div></div></div></div></div></div><div id="rec210608329" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">() =&gt;
   let
      Source = Web.Contents(
      WebServiceURL,
      [Content=Text.ToBinary(&quot;Hello&quot;)]),
      #&quot;Imported JSON&quot; = Json.Document(Source,1252)
   in
      #&quot;Imported JSON&quot;</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec210608331" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Вот запрос, который вызывает нашу функцию для каждой строки таблицы:</div></div></div></div></div></div><div id="rec210608330" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild6534-3538-4332-b235-353637306539__-__empty__image2.png" data-original="images/tild6534-3538-4332-b235-353637306539__image2.png" imgfield="img" /><meta itemprop="image" content="images/tild6534-3538-4332-b235-353637306539__image2.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec210608332" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">let
      Source = Excel.CurrentWorkbook(){[Name=&quot;MyTable&quot;]}[Content],
      #&quot;Changed Type&quot; = Table.TransformColumnTypes(
      Source,
      {{&quot;Row&quot;, Int64.Type}}),
      #&quot;Invoked Custom Function&quot; = Table.AddColumn(
      #&quot;Changed Type&quot;,
      &quot;fnCallWebService&quot;,
      each fnCallWebService())
   in
      #&quot;Invoked Custom Function&quot;</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec210608334" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">В приведённом выше запросе мы использовали кнопку <em>Invoke Custom Function</em> для вызова нашей функции на каждой строке таблицы источника, результат функции записали в новый столбец. Результат:</div></div></div></div></div></div><div id="rec210608333" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild3938-3661-4335-a334-393463313763__-__empty__image3.png" data-original="images/tild3938-3661-4335-a334-393463313763__image3.png" imgfield="img" /><meta itemprop="image" content="images/tild3938-3661-4335-a334-393463313763__image3.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec210608336" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Хотя функция вызывается четыре раза, один раз для каждой строки таблицы, веб-сервис вызывается один раз. В нашем случае Power BI/Power Query определяет, что четыре раза происходит одинаковый запрос к веб-сервису. Поэтому обращение идёт один раз, а в трёх остальных случаях используется результат кэширования. <br /><br /> Один из способов избежать кэширования — это добавление заголовка HTTP к запросу веб-сервису и передача различных значений в этом заголовке при каждом вызове. Вот другая версия нашей функции <em>fnCallWebServiceWithHeaders</em>, она принимает число в качестве параметра и передаёт его на веб-сервис в заголовке <em>MyHeader</em>:<br /></div></div></div></div></div></div><div id="rec210608337" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">(RowNum as number) =&gt; let
      Source = Web.Contents(
      WebServiceURL,
      [Content=Text.ToBinary(&quot;Hello&quot;),
      Headers=[MyHeader=Text.From(RowNum)]]),
      #&quot;Imported JSON&quot; = Json.Document(Source,1252)
   in
      #&quot;Imported JSON&quot;</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec210608339" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Теперь при каждом вызове этой функции в неё передаётся значение столбца [Row]:</div></div></div></div></div></div><div id="rec210608341" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild3163-6637-4266-b862-386633313635__-__empty__image4.png" data-original="images/tild3163-6637-4266-b862-386633313635__image4.png" imgfield="img" /><meta itemprop="image" content="images/tild3163-6637-4266-b862-386633313635__image4.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec210608343" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto"> let
      Source = Excel.CurrentWorkbook(){[Name=&quot;MyTable&quot;]}[Content],
      #&quot;Changed Type&quot; = Table.TransformColumnTypes(
      Source,
      {{&quot;Row&quot;, Int64.Type}}),
      #&quot;Invoked Custom Function&quot; = Table.AddColumn(
      #&quot;Changed Type&quot;,
      &quot;fnCallWebServiceWithHeaders&quot;,
      each fnCallWebServiceWithHeaders([Row]))
   in
      #&quot;Invoked Custom Function&quot;</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec210608344" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">…веб-сервис вызывается четыре раза. Наличие разных значений в заголовке <em>MyHeader</em> достаточно, чтобы остановить кэширование. <br /><br /> Однако можно заставить Power BI/Power Query игнорировать заголовки в отдельных случаях, если для них необходимо кэширование. Для этого применим параметр <em>ExcludedFromCacheKey</em> функции <em>Web.Contents()</em>. Ещё один вариант нашей функции, названной <em>fnCallWebServiceWithHeadersExlCache</em>:<br /></div></div></div></div></div></div><div id="rec210608347" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto"> (RowNum as number) =&gt;
   let
      Source = Web.Contents(
      WebServiceURL,
      [Content=Text.ToBinary(&quot;Hello&quot;),
      Headers=[MyHeader=Text.From(RowNum)],
      ExcludedFromCacheKey={&quot;MyHeader&quot;}]),
      #&quot;Imported JSON&quot; = Json.Document(Source,1252)
   in
      #&quot;Imported JSON&quot;</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec210608349" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Параметр <em>ExcludedFromCacheKey</em> принимает список текстовых значений, представляющих имена заголовков, которые должны игнорироваться при кэшировании запроса. В нашем случае присутствует только один заголовок – <em>MyHeader</em>. И если мы составим такой запрос:</div></div></div></div></div></div><div id="rec210608350" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto"> let
      Source = Excel.CurrentWorkbook(){[Name=&quot;MyTable&quot;]}[Content],
      #&quot;Changed Type&quot; = Table.TransformColumnTypes(
      Source,
      {{&quot;Row&quot;, Int64.Type}}),
      #&quot;Invoked Custom Function&quot; = Table.AddColumn(
      #&quot;Changed Type&quot;,
      &quot;fnCallWebServiceWithHeaders&quot;,
      each fnCallWebServiceWithHeadersExlCache([Row]))
   in
      #&quot;Invoked Custom Function&quot;</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec210608352" class="r t-rec t-rec_pt_0 t-rec_pb_120" style="padding-top:0px;padding-bottom:120px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">…то, несмотря на вызов функции для каждой строки и наличия разных значений в заголовке <em>MyHeader</em>, обращение к сервису происходит один раз, а три раза используется кэш. <br /><br /> <strong><em data-redactor-tag="em">Подведём итог</em></strong>. Если вы несколько раз вызываете в запросе веб-сервис, особенно с использованием параметра <em>Headers</em> функции <em>Web.Contents()</em>, важно понимать, как это работает. Потому что кэширование оказывает сильное влияние на быстродействие запроса.<br /></div></div></div></div></div></div></div><!--/allrecords-->