<!--allrecords--><div id="allrecords" data-tilda-export="yes" class="t-records" data-hook="blocks-collection-content-node" data-tilda-project-id="14542" data-tilda-page-id="12602487" data-tilda-page-alias="blog/obrabotka-oshibki-not-found-funktsiej-web-contents-v-power-query-i-power-bi" data-tilda-formskey="2bb761110255242a2bbb1bf3f837b680" data-tilda-lazy="yes" data-tilda-project-headcode="yes"><!--header--><div id="t-header" class="t-records" data-hook="blocks-collection-content-node" data-tilda-project-id="14542" data-tilda-page-id="61936" data-tilda-page-alias="header" data-tilda-formskey="2bb761110255242a2bbb1bf3f837b680" data-tilda-project-headcode="yes"></div><!--/header--><div id="rec210285461" class="r t-rec" style=" " data-animationappear="off" data-record-type="891" ><!-- cover --><div class="t-cover" id="recorddiv210285461" bgimgfield="img" style="height:450px; background-image:-webkit-linear-gradient(top, #ccc, #777); background-image:-moz-linear-gradient(top, #ccc, #777); background-image:-o-linear-gradient(top, #ccc, #777); background-image:-ms-linear-gradient(top, #ccc, #777); background-image:linear-gradient(top, #ccc, #777); " ><div class="t-cover__carrier" id="coverCarry210285461" data-content-cover-id="210285461" data-content-cover-bg="" data-content-cover-height="450px" data-content-cover-parallax="" style="height:450px;background-attachment:scroll; "></div> <div class="t-cover__filter" style="height:450px;background-image: -moz-linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));background-image: -webkit-linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));background-image: -o-linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));background-image: -ms-linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));background-image: linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));filter: progid:DXImageTransform.Microsoft.gradient(startColorStr='#000e1f2f', endColorstr='#00182d42');"></div><div class="t891"> <div class="t-container"> <div class="t-col t-col_12"> <div class="t-cover__wrapper t-valign_middle" style="height:450px;"> <div class="t891__wrapper" data-hook-content="covercontent"> <div class="t891__title t-title t-title_xl" style="padding-top:100px;text-shadow: 0px 2px 5px rgba(0, 0, 0, 0.0);" field="title"><div style="font-size:46px;text-align:left;" data-customstyle="yes">Обработка ошибки 404–Not Found функцией Web.Contents() в Power Query и Power BI<br /></div></div> <div class="t891__descr t-descr t-descr_xl " style="" field="descr"><div style="font-size:18px;text-align:left;" data-customstyle="yes">Текст представляет собой адаптированный перевод статьи Chris Webb (Крис Вебб), оригинал – <a href="https://blog.crossjoin.co.uk/2016/08/09/handling-404-not-found-errors-with-web-contents-in-power-query-and-power-bi/">Handling 404–Not Found Errors With Web.Contents() In Power Query And Power BI</a>. Рассматривается англоязычный Power Query.</div></div> <span class="space"></span> </div> </div> </div> </div></div> </div> </div><div id="rec210285462" class="r t-rec t-rec_pt_90 t-rec_pb_15" style="padding-top:90px;padding-bottom:15px; " data-record-type="296" ><!-- t265 --><div class="t265"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t265__wrapper" style="background:#fafafa;"> <div class="t265__icon"> <svg x="0px" y="0px" width="24px" height="24px" viewBox="0 0 24 24" style="enable-background:new 0 0 24 24;"> <circle style="fill:#edbd11;" cx="12.125" cy="12.125" r="12"/> <g> <path style="fill:#ffffff;" d="M10.922,6.486c0-0.728,0.406-1.091,1.217-1.091s1.215,0.363,1.215,1.091c0,0.347-0.102,0.617-0.304,0.81 c-0.202,0.193-0.507,0.289-0.911,0.289C11.328,7.585,10.922,7.219,10.922,6.486z M13.252,17.792h-2.234V9.604h2.234V17.792z"/> </g> </svg> </div> <div class="t265__text t-descr t-descr_xs" style="color:#000000;" field="text"><div style="font-size:14px;" data-customstyle="yes"><a href="https://blog.crossjoin.co.uk/" style="color:rgb(0, 0, 0) !important;">Крис Вебб</a> (Chris Webb) — независимый эксперт, консультант по технологиям Analysis Services, MDX, Power Pivot, DAX, Power Query и Power BI. Его блог — это кладезь информации на тему перечисленных технологий. Вот уже более 10 лет он пишет про BI-решения от Microsoft. Количество его статей перевалило за 1000! Также Крис выступает на большом количестве различных конференций вроде SQLBits, PASS Summit, PASS BA Conference, SQL Saturdays и участвует в различных сообществах.<br />Крис любезно разрешил нам переводить его статьи на русский язык. И это одна из них.</div></div> </div> </div> </div></div></div><div id="rec210285464" class="r t-rec t-rec_pt_15 t-rec_pb_0" style="padding-top:15px;padding-bottom:0px; " data-record-type="128" ><!-- T120 --><div class="t120"> <div class="t-container t-align_left"> <div class="t-col t-col_8 t-prefix_2"> <h3 class="t120__title t-heading t-heading_sm" field="title" style="font-size:16px;">Обработка ошибки 404–Not Found функцией Web.Contents() в Power Query и Power BI<br /></h3> </div> </div></div></div><div id="rec210285465" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Одно из странных свойств функции Web.Contents() в Power Query и Power BI это то, что она не обрабатывает стандартные ошибки привычным в языке М способом. Трудно сказать баг это или фича, но подобная ситуация встречается довольно часто. Поэтому мы решили поделиться описанием проблемы и способом обойти её. <br /><br /> Во-первых, так в чём проблема? Представим, что мы хотим импортировать в Power Query или список курсов <a href="http://technitrain.com/courses.php">UK Microsoft BI and SQL Server компании Technitrain</a>. Для этого можно воспользоваться функцией <a href="https://msdn.microsoft.com/en-us/library/mt260892.aspx">Web.Contents()</a> и получить данные с <a href="http://technitrain.com/feed/">RSS feed</a>. Например, так:<br /></div></div></div></div></div></div><div id="rec210285976" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">let  
   Source = Web.Contents(&quot;http://technitrain.com/feed/&quot;)  
in  
   Source</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec210285467" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Но что произойдёт, если будет ошибка в адресе URL или другие проблемы на сайте? Следующая ссылка вернёт ошибку <em>404 – Not Found</em>, т.к. страница не существует: <br /><br /> <a href="http://technitrain.com/blahblah">http://technitrain.com/blahblah</a> <br /><br /> Если мы сделаем такой запрос:<br /></div></div></div></div></div></div><div id="rec210286468" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">let  
   Source = Web.Contents(&quot;http://technitrain.com/blahblah&quot;)  
in  
   Source</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec210286771" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Естественно, получим ошибку: <br /><br /> <em>DataSource.Error: Web.Contents failed to get contents from '<a href="http://technitrain.com/blahblah%27">http://technitrain.com/blahblah</a>' (404): Not Found</em> <br /><br /> <em>(Ошибка источника данных: Web.Contents не удалось получить данные с '<a href="http://technitrain.com/blahblah%27">http://technitrain.com/blahblah</a>' (404): Не найдено)</em><br /></div></div></div></div></div></div><div id="rec210285468" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild3032-3762-4966-a334-383362626162__-__empty__p1.png" data-original="images/tild3032-3762-4966-a334-383362626162__p1.png" imgfield="img" /><meta itemprop="image" content="images/tild3032-3762-4966-a334-383362626162__p1.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec210285469" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Хоть это и реальная проблема, попробуем обработать ошибку с помощью оператора try/otherwise:</div></div></div></div></div></div><div id="rec210287005" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">let  
   Source = try  
               Web.Contents(&quot;http://technitrain.com/blahblah&quot;)  
            otherwise  
               &quot;Error!&quot;  
in  
   Source</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec210285471" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">И это не работает, мы получаем ту же самую ошибку. Что удивительно, в некоторых случаях с более сложным кодом блок try/otherwise срабатывает. Например, здесь:</div></div></div></div></div></div><div id="rec210287209" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">let  
   Source = try  
               Xml.Tables(  
                Web.Contents(&quot;http://technitrain.com/blahblah&quot;)  
               )  
            otherwise  
               &quot;Error!&quot;  
in  
   Source</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec210285473" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Ошибка перехватывается:</div></div></div></div></div></div><div id="rec210285474" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild3438-6335-4364-a364-663562313136__-__empty__p2.png" data-original="images/tild3438-6335-4364-a364-663562313136__p2.png" imgfield="img" /><meta itemprop="image" content="images/tild3438-6335-4364-a364-663562313136__p2.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec210285475" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">На <a href="https://social.technet.microsoft.com/Forums/en-US/39537117-40c5-4ca8-8b6e-f64674342c53/error-handling-in-power-query-and-m?forum=powerquery">этом форуме</a> высказывается предположение, что это связано с ленивыми вычислениями. Но мы так и не смогли определить в каких ситуациях это работает, а в каких нет. <br /><br /> Вместо этого, можно обрабатывать конкретные ошибки HTTP, используя опцию ManualStatusHandling функции Web.Contents():<br /></div></div></div></div></div></div><div id="rec210287800" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">let  
   Source = Web.Contents(  
        &quot;http://technitrain.com/blahblah&quot;,  
        [ManualStatusHandling={404}])  
in  
   Source</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec210285477" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Опция ManualStatusHandling принимает список кодов HTTP ошибок. Если запустить пример выше, то мы увидим, что запрос перестал генерировать ошибку. <br /><br /> Следующая проблема – как узнать сработал запрос или нет? Оказывается, определить это можно, просматривая метаданные, связанные с переменной Source. Вот пример как использовать функцию <a href="https://msdn.microsoft.com/en-us/library/mt260829.aspx">Value.Metadata()</a> применительно к переменной Source:<br /></div></div></div></div></div></div><div id="rec210288083" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">let  
   Source = Web.Contents(  
       &quot;http://technitrain.com/blahblah&quot;,  
       [ManualStatusHandling={404}]),  
   GetMetadata = Value.Metadata(Source)  
in  
   GetMetadata</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec210288233" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Запрос возвращает запись, которая среди прочего содержит HTTP код ответа:</div></div></div></div></div></div><div id="rec210285478" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild6463-3965-4432-b336-656462376264__-__empty__p3.png" data-original="images/tild6463-3965-4432-b336-656462376264__p3.png" imgfield="img" /><meta itemprop="image" content="images/tild6463-3965-4432-b336-656462376264__p3.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec210288446" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Подытожим, для перехвата ошибки 404 можно использовать такой шаблон:</div></div></div></div></div></div><div id="rec210285480" class="r t-rec t-rec_pt_15 t-rec_pb_120" style="padding-top:15px;padding-bottom:120px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">let  
   Source = Web.Contents(  
       &quot;http://technitrain.com/blahblah&quot;,  
       [ManualStatusHandling={404}]),  
   GetMetadata = Value.Metadata(Source),  
   GetResponseStatus = GetMetadata[Response.Status],  
   Output = if GetResponseStatus=404 then &quot;Error!&quot; else Source  
in  
   Output</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div></div><!--/allrecords-->