<!DOCTYPE html><html> <head><meta charset="utf-8" /><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><!--metatextblock--><title>Параметры конфиденциальности данных в Power BI/Power Query, часть 3: ошибка Formula.Firewall | Блог NeedForData про Power BI и Excel для интернет-маркетинга</title><meta name="description" content="Текст представляет собой адаптированный перевод статьи Chris Webb (Крис Уэбб), оригинал – Data Privacy Settings In Power BI/Power Query, Part 3: The Formula.Firewall Error." /><meta property="og:url" content="https://needfordata.ru/blog/https-needfordata-ru-blog-data-privacy-settings-pbi-pq-part-3" /><meta property="og:title" content="Параметры конфиденциальности данных в Power BI/Power Query, часть 3: ошибка Formula.Firewall | Блог NeedForData про Power BI и Excel для интернет-маркетинга" /><meta property="og:description" content="Текст представляет собой адаптированный перевод статьи Chris Webb (Крис Уэбб), оригинал – Data Privacy Settings In Power BI/Power Query, Part 3: The Formula.Firewall Error." /><meta property="og:type" content="website" /><meta property="og:image" content="images/tild3063-3933-4537-b166-356638376433__reuss_copy35.png" /><link rel="canonical" href="https://needfordata.ru/blog/https-needfordata-ru-blog-data-privacy-settings-pbi-pq-part-3"><!--/metatextblock--><meta property="fb:app_id" content="257953674358265" /><meta name="format-detection" content="telephone=no" /><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://ws.tildacdn.com"><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" /><!-- Assets --><link rel="stylesheet" href="css/tilda-grid-3.0.min.css" type="text/css" media="all" /><link rel="stylesheet" href="css/tilda-blocks-2.14.css?t=1645254407" type="text/css" media="all" /><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Open+Sans:wght@300;400;500;600;700&subset=latin,cyrillic" rel="stylesheet"><link rel="stylesheet" href="css/tilda-animation-1.0.min.css" type="text/css" media="all" /><link rel="stylesheet" href="css/tilda-cover-1.0.min.css" type="text/css" media="all" /><link rel="stylesheet" href="css/highlight.min.css" type="text/css" media="all" /><link rel="stylesheet" href="css/tilda-slds-1.4.min.css" type="text/css" media="print" onload="this.media='all';" /><noscript><link rel="stylesheet" href="css/tilda-slds-1.4.min.css" type="text/css" media="all" /></noscript><link rel="stylesheet" href="css/tilda-zoom-2.0.min.css" type="text/css" media="print" onload="this.media='all';" /><noscript><link rel="stylesheet" href="css/tilda-zoom-2.0.min.css" type="text/css" media="all" /></noscript><script src="js/jquery-1.10.2.min.js"></script><script src="js/tilda-scripts-3.0.min.js"></script><script src="js/tilda-blocks-2.7.js?t=1645254407"></script><script src="js/lazyload-1.3.min.js" charset="utf-8" async></script><script src="js/tilda-animation-1.0.min.js" charset="utf-8" async></script><script src="js/tilda-cover-1.0.min.js" charset="utf-8" async></script><script src="js/tilda-events-1.0.min.js" charset="utf-8" async></script><script src="js/highlight.min.js" charset="utf-8"></script><script src="js/tilda-slds-1.4.min.js" charset="utf-8" async></script><script src="js/hammer.min.js" charset="utf-8" async></script><script src="js/tilda-zoom-2.0.min.js" charset="utf-8" async></script><link rel="icon" href="images/tild3662-3930-4236-a439-636138646665__needfordatafavicon.svg" type="image/svg"><script type="text/javascript">window.dataLayer = window.dataLayer || [];</script><!-- Google Tag Manager --><script type="text/javascript">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':	new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],	j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=	'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);	})(window,document,'script','dataLayer','GTM-P7MJHR');</script><!-- End Google Tag Manager --><script type="text/javascript">if((/bot|google|yandex|baidu|bing|msn|duckduckbot|teoma|slurp|crawler|spider|robot|crawling|facebook/i.test(navigator.userAgent))===false && typeof(sessionStorage)!='undefined' && sessionStorage.getItem('visited')!=='y'){	var style=document.createElement('style');	style.type='text/css';	style.innerHTML='@media screen and (min-width: 980px) {.t-records {opacity: 0;}.t-records_animated {-webkit-transition: opacity ease-in-out .2s;-moz-transition: opacity ease-in-out .2s;-o-transition: opacity ease-in-out .2s;transition: opacity ease-in-out .2s;}.t-records.t-records_visible {opacity: 1;}}';	document.getElementsByTagName('head')[0].appendChild(style);	$(document).ready(function() {	$('.t-records').addClass('t-records_animated');	setTimeout(function(){ $('.t-records').addClass('t-records_visible'); sessionStorage.setItem('visited','y');	},400);	});
}</script></head><body class="t-body" style="margin:0;"><!--allrecords--><div id="allrecords" data-tilda-export="yes" class="t-records" data-hook="blocks-collection-content-node" data-tilda-project-id="14542" data-tilda-page-id="12631582" data-tilda-page-alias="blog/https-needfordata-ru-blog-data-privacy-settings-pbi-pq-part-3" data-tilda-formskey="2bb761110255242a2bbb1bf3f837b680" data-tilda-lazy="yes" data-tilda-project-headcode="yes"><!--header--><div id="t-header" class="t-records" data-hook="blocks-collection-content-node" data-tilda-project-id="14542" data-tilda-page-id="61936" data-tilda-page-alias="header" data-tilda-formskey="2bb761110255242a2bbb1bf3f837b680" data-tilda-project-headcode="yes"></div><!--/header--><div id="rec210721521" class="r t-rec" style=" " data-animationappear="off" data-record-type="891" ><!-- cover --><div class="t-cover" id="recorddiv210721521" bgimgfield="img" style="height:450px; background-image:-webkit-linear-gradient(top, #ccc, #777); background-image:-moz-linear-gradient(top, #ccc, #777); background-image:-o-linear-gradient(top, #ccc, #777); background-image:-ms-linear-gradient(top, #ccc, #777); background-image:linear-gradient(top, #ccc, #777); " ><div class="t-cover__carrier" id="coverCarry210721521" data-content-cover-id="210721521" data-content-cover-bg="" data-content-cover-height="450px" data-content-cover-parallax="" style="height:450px;background-attachment:scroll; "></div> <div class="t-cover__filter" style="height:450px;background-image: -moz-linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));background-image: -webkit-linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));background-image: -o-linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));background-image: -ms-linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));background-image: linear-gradient(top, rgba(14,31,47,1), rgba(24,45,66,1));filter: progid:DXImageTransform.Microsoft.gradient(startColorStr='#000e1f2f', endColorstr='#00182d42');"></div><div class="t891"> <div class="t-container"> <div class="t-col t-col_12"> <div class="t-cover__wrapper t-valign_middle" style="height:450px;"> <div class="t891__wrapper" data-hook-content="covercontent"> <div class="t891__title t-title t-title_xl" style="padding-top:100px;text-shadow: 0px 2px 5px rgba(0, 0, 0, 0.0);" field="title"><div style="font-size:46px;text-align:left;" data-customstyle="yes">Параметры конфиденциальности <br />данных в Power BI/Power Query, часть 3:<br /> ошибка Formula.Firewall<br /></div></div> <div class="t891__descr t-descr t-descr_xl " style="" field="descr"><div style="font-size:18px;text-align:left;" data-customstyle="yes">Текст представляет собой адаптированный перевод статьи Chris Webb (Крис Уэбб), <br />оригинал – <a href="https://blog.crossjoin.co.uk/2017/06/26/data-privacy-settings-in-power-bipower-query-part-3-the-formula-firewall-error/">Data Privacy Settings In Power BI/Power Query, Part 3: The Formula.Firewall Error</a>.</div></div> <span class="space"></span> </div> </div> </div> </div></div> </div> </div><div id="rec210721522" class="r t-rec t-rec_pt_90 t-rec_pb_15" style="padding-top:90px;padding-bottom:15px; " data-record-type="296" ><!-- t265 --><div class="t265"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t265__wrapper" style="background:#fafafa;"> <div class="t265__icon"> <svg x="0px" y="0px" width="24px" height="24px" viewBox="0 0 24 24" style="enable-background:new 0 0 24 24;"> <circle style="fill:#edbd11;" cx="12.125" cy="12.125" r="12"/> <g> <path style="fill:#ffffff;" d="M10.922,6.486c0-0.728,0.406-1.091,1.217-1.091s1.215,0.363,1.215,1.091c0,0.347-0.102,0.617-0.304,0.81 c-0.202,0.193-0.507,0.289-0.911,0.289C11.328,7.585,10.922,7.219,10.922,6.486z M13.252,17.792h-2.234V9.604h2.234V17.792z"/> </g> </svg> </div> <div class="t265__text t-descr t-descr_xs" style="color:#000000;" field="text"><div style="font-size:14px;" data-customstyle="yes"><a href="https://blog.crossjoin.co.uk/" style="color:rgb(0, 0, 0) !important;">Крис Вебб</a> (Chris Webb) — независимый эксперт, консультант по технологиям Analysis Services, MDX, Power Pivot, DAX, Power Query и Power BI. Его блог — это кладезь информации на тему перечисленных технологий. Вот уже более 10 лет он пишет про BI-решения от Microsoft. Количество его статей перевалило за 1000! Также Крис выступает на большом количестве различных конференций вроде SQLBits, PASS Summit, PASS BA Conference, SQL Saturdays и участвует в различных сообществах.<br />Крис любезно разрешил нам переводить его статьи на русский язык. И это одна из них.</div></div> </div> </div> </div></div></div><div id="rec210721524" class="r t-rec t-rec_pt_15 t-rec_pb_0" style="padding-top:15px;padding-bottom:0px; " data-record-type="128" ><!-- T120 --><div class="t120"> <div class="t-container t-align_left"> <div class="t-col t-col_8 t-prefix_2"> <h3 class="t120__title t-heading t-heading_sm" field="title" style="font-size:16px;">Параметры конфиденциальности данных в Power BI/Power Query, часть 3: ошибка Formula.Firewall<br /></h3> </div> </div></div></div><div id="rec210721525" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">В первых двух частях данной серии (<a href="https://needfordata.ru/blog/data-privacy-settings-pbi-pq-part-1">Часть 1</a>, <a href="https://needfordata.ru/blog/data-privacy-settings-pbi-pq-part-2">Часть 2</a>) статей мы показали, как влияют настройки уровня конфиденциальности данных Power BI/Power Query/Excel Get &amp; Transform на складывание запроса и на возможность его выполнения. В этой статье рассматривается ситуация, когда, независимо от применённых уровней конфиденциальности данных, запрос не выполняется и генерируется печально известная ошибка Formula.Firewall. <br /><br /> Признаемся, что абсолютного понимания заявленной темы нет (и вряд ли кто-то может похвастаться таким, кроме команды разработчиков Power Query). Поэтому в статье даётся объяснение, исходя из наших знаний, а также рассматриваются несколько сценариев возникновения ошибок и показывается, как с ними работать. <br /><br /> Используем два источника данных из предыдущих частей. Книгу Excel, содержащую название дня недели, и таблицу DimDate в базе данных SQL, которую можно отфильтровать по дню недели, взятому в Excel. Оба источника имеют уровень Public. Следующий запрос FilterDay загружает данные из книги и возвращает текстовое значение, содержащее название дня недели:<br /></div></div></div></div></div></div><div id="rec210721528" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">let
    Source = 
    Excel.Workbook(
        File.Contents(&quot;C:\FilterParameter.xlsx&quot;), 
    null, true),
    FilterDay_Table = 
    Source{[Item=&quot;FilterDay&quot;,Kind=&quot;Table&quot;]}[Data],
    ChangedType = 
    Table.TransformColumnTypes(
        FilterDay_Table,
        {{&quot;Parameter&quot;, type text}}
    ),
    Output = 
    ChangedType{0}[#&quot;Parameter&quot;]
in
    Output</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec210721526" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild6234-3834-4730-a432-623230626462__-__empty__image1-2.png" data-original="images/tild6234-3834-4730-a432-623230626462__image1-2.png" imgfield="img" /><meta itemprop="image" content="images/tild6234-3834-4730-a432-623230626462__image1-2.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec210721527" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Давайте взглянем на следующий запрос:</div></div></div></div></div></div><div id="rec210721973" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">let
    Source = 
    Sql.Database(
        &quot;localhost&quot;, 
        &quot;adventure works dw&quot;,
        [Query=&quot;select DateKey, EnglishDayNameOfWeek 
        from DimDate&quot;]),
    FilteredRows = 
    Table.SelectRows(Source, 
        each ([EnglishDayNameOfWeek] = FilterDay)
    )
in
    FilteredRows</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec210721529" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Он фильтрует содержимое таблицы DimDate, возвращая только те строки, в которых столбец EnglishDayNameOfWeek соответствует названию дня, полученному запросом FilterDay. Обратите внимание, что в запросе два шага: Source (который выполняет SQL запрос) и FilteredRows (который выполняет фильтрацию). На выходе получаем:</div></div></div></div></div></div><div id="rec210721530" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild6533-3639-4261-a165-316233386338__-__empty__image2-2.png" data-original="images/tild6533-3639-4261-a165-316233386338__image2-2.png" imgfield="img" /><meta itemprop="image" content="images/tild6533-3639-4261-a165-316233386338__image2-2.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec210721531" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Как видно на скриншоте, запрос выполняется. На самом деле он будет работать при любых параметрах конфиденциальности. Стоит отметить, что при использовании в коде собственного SQL запроса, Query Folding на последующих шагах не происходит (как в нашем случае). <br /><br /> Теперь взглянем на другую версию запроса:<br /></div></div></div></div></div></div><div id="rec210722082" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">let
    Source = 
    Table.SelectRows(
        Sql.Database(
            &quot;localhost&quot;, 
            &quot;adventure works dw&quot;,
            [Query=&quot;select DateKey, 
                EnglishDayNameOfWeek 
                from DimDate&quot;]
        ), 
        each ([EnglishDayNameOfWeek] = FilterDay)
    )
in
    Source</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec210722123" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Важное отличие состоит в том, что теперь в запросе один шаг, а не два. Запрос и фильтрация происходят на одном шаге. Что более важно, независимо от параметров уровней конфиденциальности, запрос завершается ошибкой. Выдаётся предупреждение, что одношаговый запрос к DimDate не выполнен, т.к. он ссылается на другие запросы или шаги и не может напрямую получить доступ к источнику данных.</div></div></div></div></div></div><div id="rec210721532" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-record-type="224" ><!-- T196 --><div class="t196"> <div class="t-container" itemscope itemtype="http://schema.org/ImageObject"> <div class="t-col t-col_8 t-prefix_2 t-align_center"> <img class="t196__img t-img" src="images/tild3662-6566-4264-b761-613564373466__-__empty__image3-2.png" data-original="images/tild3662-6566-4264-b761-613564373466__image3-2.png" imgfield="img" /><meta itemprop="image" content="images/tild3662-6566-4264-b761-613564373466__image3-2.png"> </div> <div class="t-col t-col_2 "> <div class="t196__descr t-descr t-descr_xs" style="" field="title" itemprop="name"></div> </div> </div></div></div><div id="rec210722166" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Проблема заключается в том, что движок Power Query не позволяет получить доступ к двум разным источникам данных, полученных от разных запросов на одном шаге. Мы думаем, что это происходит из-за проблем с определением допустимо ли соединение или нет, исходя из правил конфиденциальности. <br /><br /> На этом этапе можно подумать, что во избежание ошибки достаточно разбить запрос на несколько шагов, как в примере выше. Однако есть ситуации, когда обойти проблему не так просто. Для примера рассмотрим следующий запрос:<br /></div></div></div></div></div></div><div id="rec210722262" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">let
    Source = 
    Sql.Database(
        &quot;localhost&quot;, 
        &quot;adventure works dw&quot;,
        [Query=&quot;
         select DateKey, EnglishDayNameOfWeek 
         from DimDate 
         where 
         EnglishDayNameOfWeek=&#039;&quot; &amp; FilterDay &amp; &quot;&#039;&quot; 
        ]
    )
in
    Source</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec210722369" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">В этом примере мы динамически генерируем SQL запрос и передаем название дня недели для фильтра в условие WHERE. В двух предыдущих примерах в запросах не было WHERE и фильтрация осуществлялась внутри Power BI. В данном случае фильтрация происходит в запросе, и для генерации условия WHERE необходимо ссылаться на результат запроса FilterDay в том же шаге. Поэтому запрос возвращает ту же самую ошибку Formula.Firewall, что и в приведённом выше примере. <br /><br /> Так как обойти ошибку? Что ж, следующая версия запроса, который ссылается на FilterDay в отдельном шаге тоже не работает:<br /></div></div></div></div></div></div><div id="rec210722440" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">let
    DayAsStep = FilterDay,
    Source = 
    Sql.Database(
        &quot;localhost&quot;, 
        &quot;adventure works dw&quot;,
        [Query=&quot;
         select DateKey, EnglishDayNameOfWeek 
         from DimDate 
         where 
         EnglishDayNameOfWeek=&#039;&quot; &amp; DayAsStep &amp; &quot;&#039;&quot; 
        ]
    )
in
    Source</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec210722471" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">К счастью, проблему можно решить, применив функцию Value.NativeQuery(). В одной из предыдущих статей мы показали, как использовать эту функцию для передачи параметров в запросы SQL. Сгенерируем на отдельном шаге запись, содержащую параметры запроса (в коде это ParamRecord):</div></div></div></div></div></div><div id="rec210722504" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">let
    Source = Sql.Database(&quot;localhost&quot;, &quot;adventure works dw&quot;),
    ParamRecord = [FilterParameter=FilterDay],
    Query = Value.NativeQuery(
                Source, 
                &quot;select DateKey, EnglishDayNameOfWeek 
        from DimDate 
        where 
        EnglishDayNameOfWeek=@FilterParameter&quot;,
                ParamRecord)
in
    Query</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec210722551" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Теперь запрос выполняется успешно. <br /><br /> Существует другой способ избежать ошибки. В предыдущих примерах использовались два запроса: в одном мы получали данные из Excel, в другом фильтровали данные сервера SQL. Если соединить два запроса в один, то можно обратиться к данным разных источников на одном шаге. В примере ниже, запрос не ссылается на результаты других запросов. Наименование дня недели получаем на шаге ExcelSource, затем запускаем динамический SQL запрос на шаге SQLSource. Весь запрос завершается успешно:<br /></div></div></div></div></div></div><div id="rec210722622" class="r t-rec t-rec_pt_15 t-rec_pb_15" style="padding-top:15px;padding-bottom:15px; " data-animationappear="off" data-record-type="285" ><!-- t264 --><div class="t264"> <div class="t-container"> <div class="t-col t-col_8 t-prefix_2"> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="auto">let
    ExcelSource = 
    Excel.Workbook(
        File.Contents(&quot;C:\FilterParameter.xlsx&quot;)
    , null, true),
    FilterDay_Table = 
    ExcelSource{[Item=&quot;FilterDay&quot;,Kind=&quot;Table&quot;]}[Data],
    ChangedType = 
    Table.TransformColumnTypes(FilterDay_Table,
        {{&quot;Parameter&quot;, type text}}),
    FilterDayStep = 
    ChangedType{0}[#&quot;Parameter&quot;],
    SQLSource = Sql.Database(
    &quot;localhost&quot;, 
    &quot;adventure works dw&quot;,
    [Query=&quot;
        select DateKey, EnglishDayNameOfWeek 
        from DimDate 
        where 
        EnglishDayNameOfWeek=&#039;&quot; 
        &amp; FilterDayStep &amp; 
        &quot;&#039;&quot; ])
in
    SQLSource</code></pre> </div> </div> </div></div> <script type="text/javascript"> $(document).ready(function(){	hljs.initHighlightingOnLoad(); }); </script> <style type="text/css"> .t264 .hljs { background-color: ; }</style> </div><div id="rec210721533" class="r t-rec t-rec_pt_0 t-rec_pb_0" style="padding-top:0px;padding-bottom:0px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Очевидно, что движок M не испытывает проблем с доступом к данным разных источников на одном шаге, если эти источники созданы в одном запросе. <br /><br /> Если отключить проверку конфиденциальности в соответствующем диалоге, то мы уберём ошибку Formula.Firewall и получим Query Folding в каждом возможном случае. Эту тему мы рассмотрим в следующей статье.<br /></div></div></div></div></div></div><div id="rec230242770" class="r t-rec t-rec_pt_0 t-rec_pb_105" style="padding-top:0px;padding-bottom:105px; " data-record-type="106" ><!-- T004 --><div class="t004"><div class="t-container "> <div class="t-col t-col_8 t-prefix_2"><div field="text" class="t-text t-text_md " style=""><div style="font-size:14px;" data-customstyle="yes">Другие статьи цикла:<br />- <a href="https://needfordata.ru/blog/data-privacy-settings-pbi-pq-part-1">часть 1</a> <br />- <a href="https://needfordata.ru/blog/data-privacy-settings-pbi-pq-part-2">часть 2</a> <br />- <a href="https://needfordata.ru/blog/data-privacy-settings-pbi-pq-part-3">часть 3</a> <br />- <a href="https://needfordata.ru/blog/data-privacy-settings-pbi-pq-part-4">часть 4</a> <br />- <a href="https://needfordata.ru/blog/data-privacy-settings-pbi-pq-part-5">часть 5</a> <br /><br /></div></div></div></div></div></div></div><!--/allrecords--><!-- Stat --><script type="text/javascript">if (! window.mainTracker) { window.mainTracker = 'tilda'; }	setTimeout(function(){	(function (d, w, k, o, g) { var n=d.getElementsByTagName(o)[0],s=d.createElement(o),f=function(){n.parentNode.insertBefore(s,n);}; s.type = "text/javascript"; s.async = true; s.key = k; s.id = "tildastatscript"; s.src=g; if (w.opera=="[object Opera]") {d.addEventListener("DOMContentLoaded", f, false);} else { f(); } })(document, window, '4eb7231bc2c18471490f34b4b396f16e','script','js/tilda-stat-1.0.min.js');	}, 2000);</script><!-- Google Tag Manager (noscript) --><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P7MJHR" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><!-- End Google Tag Manager (noscript) --></body></html>